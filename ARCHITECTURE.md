# Architecture Blueprint: Solana Security & Performance Framework

## 1. Abstract
This repository serves as a dual-purpose reference implementation:
1.  **Educational Vulnerability Archive:** A catalog of 7 critical Solana vulnerability patterns, ranging from basic checks to complex system-level exploits.
2.  **Performance Research Lab:** A benchmarking environment comparing the Compute Unit (CU) and memory overhead of "Safe Anchor" abstractions versus "Safe Pinocchio" (raw systems) implementations.

The core philosophy is **"Performance Security"**: demonstrating that low-level optimization (Pinocchio) does not require sacrificing safety if rigorous manual invariants (Discriminators, Alignment, Memory Lifecycle) are enforced.

---

## 2. Directory Structure
The repository is organized as a Rust Cargo Workspace. Each vulnerability is isolated into its own crate to allow for independent fuzzing and benchmarking.

```text
solana-security-framework/
├── .github/
│   └── workflows/
│       ├── ci.yml                 # Linting, Build, Unit Tests
│       └── benchmark.yml          # Automated Mollusk CU Comparison Reports
├── benchmarks/                    # Mollusk-SVM-Bencher configuration & outputs
│   ├── reports/                   # Markdown tables generated by CI
│   └── src/                       # Benchmarking harness
├── docs/                          # Docusaurus Static Site (The "Article")
│   ├── docs/
│   │   ├── intro.md
│   │   └── vulnerabilities/       # Deep-dive explanations per pattern
│   └── src/
├── programs/                      # The 7 Core Examples
│   ├── 01-missing-signer/         # Tier 1: Sanity Check
│   ├── 02-arithmetic-overflow/    # Tier 2: Core Logic
│   ├── 03-pda-seed-leak/          # Tier 2: Privacy/Core
│   ├── 04-account-closing/        # Tier 2: Systems/Memory
│   ├── 05-type-confusion/         # Tier 3: Pinocchio Specific
│   ├── 06-zero-copy-alignment/    # Tier 3: Systems/Arch
│   └── 07-hook-reentrancy/        # Tier 3: Token-2022 Frontier
├── tests/                         # Integration Tests (Bankrun + Trident)
├── Anchor.toml                    # Anchor Workspace Config
├── Cargo.toml                     # Workspace Root
└── README.md                      # Entry point (Video Link + Summary)

3. Vulnerability Matrix (The "Sweet Spot")
Each program crate strictly follows a mod insecure vs mod secure pattern to facilitate side-by-side diffing.
| ID | Vulnerability | Category | Tech Focus | Implementation Goal |
|---|---|---|---|---|
| 01 | Missing Signer | Sanity | Anchor | Baseline validation check. |
| 02 | Integer Overflow | Core | Rust | checked_add vs standard operators. |
| 03 | PDA Metadata Leak | Privacy | Systems | "Salted Hash" derivation to hide PII in seeds. |
| 04 | Zombie Resurrection | Memory | Pinocchio | Manual memset(0) vs standard Lamport transfer. |
| 05 | Type Confusion | Safety | Pinocchio | Manual 8-byte Discriminator injection & verification. |
| 06 | Unaligned Pointer | Hardware | Pinocchio | #[repr(C)] padding & bytemuck safe casting. |
| 07 | Transfer Hook Reentrancy | Complex | Token-22 | CEI Pattern (Checks-Effects-Interactions) in CPIs. |
4. Benchmarking Methodology (Mollusk)
We utilize mollusk-svm-bencher to treat security costs as a measurable metric.
Strategy
Every secure implementation is benchmarked in two modes:
 * Anchor Secure: The standard framework overhead.
 * Pinocchio Secure: The optimized, raw-Rust equivalent with manual safety rails.
CI Integration
The .github/workflows/benchmark.yml pipeline triggers on every PR. It compiles the programs, runs the Mollusk harness, and outputs a comparative table:
| Program | Anchor Secure (CU) | Pinocchio Secure (CU) | Optimization Delta |
|---|---|---|---|
| Type Confusion | 2,100 | 450 | -78% |
| Zero-Copy | 5,400 | 820 | -84% |
5. Testing & Verification Layer
Unit & Integration (Bankrun)
Standard logic verification using solana-program-test (Bankrun mode) for speed.
 * Location: tests/bankrun/*.rs
 * Coverage: Happy path + Error path assertions.
Invariant Fuzzing (Trident)
We apply Trident fuzz testing specifically to the Tier 3 examples (06 & 07) to prove robustness under chaos.
 * Target: 07-hook-reentrancy
 * Invariant: vault_balance >= sum(user_deposits)
 * Fuzzer: Generates random sequences of Deposit -> Withdraw -> MaliciousHook to attempt double-spending.
6. Documentation (Docusaurus)
The docs/ folder contains a Docusaurus instance that builds the static educational site.
 * Pipeline: Deploys via GitHub Actions to GitHub Pages.
 * Content Strategy:
   * The "Why": Explains the vulnerability impact (High/Medium/Low).
   * The "How": Visualizes the memory layout (for Alignment/Closing examples).
   * The "Fix": Line-by-line breakdown of the secure implementation.
7. Standards Compliance
 * Security.txt: All programs include the solana-security-txt macro to adhere to mainnet deployment standards.
 * Clippy: All code must pass cargo clippy -- -D warnings (no dead code, no loose constraints).
 * Formatter: cargo fmt enforced.
<!-- end list -->

